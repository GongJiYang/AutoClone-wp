# API 测试和速率限制处理指南

## 测试脚本

使用 `scripts/test_api.py` 测试视觉模型 API 并验证速率限制处理。

### 基本用法

```bash
# 使用默认设置测试（5次请求，间隔1秒）
python scripts/test_api.py

# 测试指定模型
python scripts/test_api.py --model glm-4.6v --count 10

# 增加请求间隔（推荐用于避免速率限制）
python scripts/test_api.py --model glm-4.6v --count 10 --delay 2

# 禁用自动重试（仅测试单次请求）
python scripts/test_api.py --count 1 --no-retry
```

### 参数说明

- `--model`: 模型名称（默认: `glm-4.6v`）
- `--count`: 请求数量（默认: 5）
- `--delay`: 请求间隔秒数（默认: 1.0）
- `--no-retry`: 禁用自动重试

### 输出示例

```
============================================================
🧪 API请求测试
============================================================
🤖 模型: glm-4.6v
📊 请求数量: 5
⏱️  请求间隔: 2.0 秒
🔄 速率限制处理: 启用
============================================================

📤 请求 #1: glm-4.6v
   ✅ 成功! 耗时: 2.34秒
   📝 响应: 这是一张测试图片...

📤 请求 #2: glm-4.6v
   ⏳ 延迟 2.0 秒...
   ✅ 成功! 耗时: 2.15秒
   ...

============================================================
📊 测试结果统计
============================================================
✅ 成功: 5/5
❌ 失败: 0/5
⏱️  总耗时: 12.50 秒
📈 平均耗时: 2.50 秒/请求
============================================================
```

## 速率限制处理机制

### 自动重试策略

系统实现了**指数退避重试机制**：

1. **初始延迟**: 2秒
2. **最大延迟**: 60秒
3. **最大重试次数**: 5次
4. **延迟计算**: `delay = min(initial_delay * 2^retry_count, max_delay)`
5. **随机抖动**: ±20% 避免同时重试

### 重试条件

以下错误会自动重试：
- **429**: 速率限制
- **500, 502, 503**: 服务器错误

以下错误**不会**重试：
- **1113**: 余额不足（需要充值）
- 其他客户端错误

### 改善方法

#### 1. 增加请求间隔

```bash
# 推荐：间隔2-3秒
python scripts/test_api.py --delay 2

# 高频率场景：间隔1秒
python scripts/test_api.py --delay 1
```

#### 2. 批量处理时使用延迟

在 `scripts/analyze.py` 中，每个分块分析之间已经有 1 秒延迟：

```python
time.sleep(1)  # 避免API限流
```

可以增加到 2 秒：

```python
time.sleep(2)  # 更安全的间隔
```

#### 3. 分批处理

对于大量 URL，使用 `--limit` 参数分批处理：

```bash
# 每次处理10个
python scripts/batch.py --limit 10

# 处理完一批后，等待一段时间再处理下一批
```

#### 4. 监控和调整

- 观察失败率，如果 >10% 则增加延迟
- 检查 API 配额和余额
- 使用测试脚本验证当前速率限制

## 在 analyze.py 中的改进

`VisionAnalyzer` 类现在包含：

1. **自动重试**: 遇到速率限制时自动重试
2. **指数退避**: 每次重试延迟时间递增
3. **错误识别**: 区分可重试和不可重试的错误
4. **友好提示**: 显示重试进度

### 配置参数

可以在创建 `VisionAnalyzer` 时自定义：

```python
analyzer = VisionAnalyzer(
    max_retries=5,      # 最大重试次数
    initial_delay=2.0,  # 初始延迟（秒）
    max_delay=60.0      # 最大延迟（秒）
)
```

## 最佳实践

### 1. 测试阶段

```bash
# 先用小批量测试
python scripts/test_api.py --count 3 --delay 2

# 确认无问题后再批量处理
python scripts/batch.py --limit 10
```

### 2. 生产环境

- 请求间隔: **2-3秒**
- 批量大小: **5-10个URL**
- 启用自动重试: **是**
- 监控失败率: **<5%**

### 3. 高并发场景

如果需要在短时间内处理大量请求：

1. 使用队列系统（如 Celery）
2. 实现令牌桶算法
3. 分布式处理，每个进程独立限流
4. 考虑使用多个 API 密钥（如果允许）

## 故障排查

### 问题：频繁出现 429 错误

**解决方案**:
1. 增加 `--delay` 到 2-3 秒
2. 检查 API 配额是否充足
3. 减少并发请求数量

### 问题：余额不足 (1113)

**解决方案**:
1. 检查 API 账户余额
2. 充值或购买资源包
3. 检查是否有其他应用在使用同一密钥

### 问题：响应时间过长

**解决方案**:
1. 检查网络连接
2. 尝试使用更快的模型（如 `glm-4v-flash`）
3. 优化图片大小（压缩截图）

## 相关文件

- `scripts/test_api.py`: API 测试脚本
- `src/core/analyzer.py`: 视觉分析器（包含重试逻辑）
- `scripts/analyze.py`: 页面分析脚本
- `scripts/batch.py`: 批量处理脚本
